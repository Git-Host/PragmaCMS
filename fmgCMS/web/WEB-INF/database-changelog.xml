<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog logicalFilePath="database-changelog.xml"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet author="fmguler" id="init">
    </changeSet>
    <changeSet author="fmguler" id="0">
        <tagDatabase tag="tag-init"/>
    </changeSet>
    <!-- CMS SCHEMA >> -->
    <changeSet author="fmguler" id="1">
        <createTable schemaName="public" tableName="attribute">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="attribute_pkey"/>
            </column>
            <column name="type" type="VARCHAR(1000)"/>
            <column name="attribute" type="VARCHAR(1000)"/>
            <column name="value" type="TEXT"/>
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="2">
        <createTable schemaName="public" tableName="template">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="template_pkey"/>
            </column>
            <column name="name" type="VARCHAR(1000)"/>
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="3">
        <createTable schemaName="public" tableName="page">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="page_pkey"/>
            </column>
            <column name="path" type="VARCHAR(1000)"/>
            <column name="template_id" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="4">
        <createTable schemaName="public" tableName="template_attribute">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="template_attribute_pkey"/>
            </column>
            <column name="template_id" type="int4">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="5">
        <createTable schemaName="public" tableName="page_attribute">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="page_attribute_pkey"/>
            </column>
            <column name="page_id" type="int4">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="6">
        <addForeignKeyConstraint 
            constraintName="page_template_id_fkey"
            baseTableSchemaName="public" baseTableName="page" baseColumnNames="template_id"
            referencedTableSchemaName="public"   referencedTableName="template" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    <changeSet author="fmguler" id="7">
        <addForeignKeyConstraint 
            constraintName="template_attribute_template_id_fkey"
            baseTableSchemaName="public" baseTableName="template_attribute" baseColumnNames="template_id"
            referencedTableSchemaName="public"   referencedTableName="template" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    <changeSet author="fmguler" id="8">
        <addForeignKeyConstraint 
            constraintName="template_attribute_attribute_id_fkey"
            baseTableSchemaName="public" baseTableName="template_attribute" baseColumnNames="attribute_id"
            referencedTableSchemaName="public"   referencedTableName="attribute" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    
    <changeSet author="fmguler" id="9">
        <addForeignKeyConstraint 
            constraintName="page_attribute_page_id_fkey"
            baseTableSchemaName="public" baseTableName="page_attribute" baseColumnNames="page_id"
            referencedTableSchemaName="public"   referencedTableName="page" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    <changeSet author="fmguler" id="10">
        <addForeignKeyConstraint 
            constraintName="page_attribute_attribute_id_fkey"
            baseTableSchemaName="public" baseTableName="page_attribute" baseColumnNames="attribute_id"
            referencedTableSchemaName="public"   referencedTableName="attribute" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    <changeSet author="fmguler" id="11">
        <tagDatabase tag="tag-basic-domain"/>
    </changeSet>
    <changeSet author="fmguler" id="12">
        <createTable schemaName="public" tableName="attribute_enum">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="attribute_enum_pkey"/>
            </column>
            <column name="attribute_name" type="VARCHAR(1000)"/>
            <column name="attribute_type" type="int"/>
            <column name="template_id" type="int"/>
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="13">
        <addForeignKeyConstraint
            constraintName="attribute_enum_template_id_fkey"
            baseTableSchemaName="public" baseTableName="attribute_enum" baseColumnNames="template_id"
            referencedTableSchemaName="public" referencedTableName="template" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    <changeSet author="fmguler" id="14">
        <tagDatabase tag="tag-enum"/>
    </changeSet>
    <!-- << CMS SCHEMA -->
    <!-- NEW SIMPLIFIED SCHEMA >> -->
    <changeSet author="fmguler" id="15">
        <addColumn tableName="page_attribute" schemaName="public">
            <column name="attribute" type="VARCHAR(1000)"/>
            <column name="value" type="TEXT"/>
            <column name="version" type="int"/>
            <column name="author" type="VARCHAR(1000)"/>
            <column name="comment" type="VARCHAR(1000)"/>
            <column name="date" type="TIMESTAMP WITHOUT TIME ZONE" />
        </addColumn>
    </changeSet>
    <changeSet author="fmguler" id="16">
        <addColumn tableName="template_attribute" schemaName="public">
            <column name="attribute" type="VARCHAR(1000)"/>
            <column name="value" type="TEXT"/>
            <column name="version" type="int"/>
            <column name="author" type="VARCHAR(1000)"/>
            <column name="comment" type="VARCHAR(1000)"/>
            <column name="date" type="TIMESTAMP WITHOUT TIME ZONE" />
        </addColumn>
    </changeSet>
    <changeSet author="fmguler" id="17">
        <sql>
            UPDATE page_attribute SET attribute = (select a.attribute from attribute a where a.id = attribute_id), value = (select a.value from attribute a where a.id = attribute_id), version = 0, author = 'admin', comment= '', date = now();
            UPDATE template_attribute SET attribute = (select a.attribute from attribute a where a.id = attribute_id), value = (select a.value from attribute a where a.id = attribute_id), version = 0, author = 'admin', comment= '', date = now();
        </sql>
        <rollback/>
    </changeSet>
    <!-- Note: this change does not support rollback, and will screw db if you do so -->
    <changeSet author="fmguler" id="18">
        <dropForeignKeyConstraint constraintName="page_attribute_attribute_id_fkey" baseTableName="page_attribute"/>
        <dropForeignKeyConstraint constraintName="template_attribute_attribute_id_fkey" baseTableName="template_attribute"/>
        <dropTable tableName="attribute" schemaName="public" />        
        <dropColumn tableName="page_attribute" columnName="attribute_id"/>
        <dropColumn tableName="template_attribute" columnName="attribute_id"/>
    </changeSet>
    <changeSet author="fmguler" id="19">
        <dropTable tableName="attribute_enum" schemaName="public"/>
    </changeSet>
    <changeSet author="fmguler" id="20">
        <tagDatabase tag="tag-simplified-domain"/>
    </changeSet>
    <!-- << NEW SIMPLIFIED SCHEMA -->
    <!-- ATTACHMENT SUPPORT >> -->
    <changeSet author="fmguler" id="21">
        <createTable schemaName="public" tableName="page_attachment">
            <column autoIncrement="true" name="id" type="serial">
                <constraints nullable="false" primaryKey="true" primaryKeyName="page_attachment_pkey"/>
            </column>
            <column name="page_id" type="int4">
                <constraints nullable="false"/>
            </column>            
            <column name="name" type="VARCHAR(1000)"/>
            <column name="content_key" type="VARCHAR(1000)"/>
            <column name="content_type" type="VARCHAR(1000)"/>
            <column name="content_length" type="int"/>
            <column name="last_modified" type="TIMESTAMP WITHOUT TIME ZONE" />
        </createTable>
    </changeSet>
    <changeSet author="fmguler" id="22">
        <addForeignKeyConstraint 
            constraintName="page_attachment_attribute_id_fkey"
            baseTableSchemaName="public" baseTableName="page_attachment" baseColumnNames="page_id"
            referencedTableSchemaName="public"   referencedTableName="page" referencedColumnNames="id"
            deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" />
    </changeSet>
    <changeSet author="fmguler" id="23">
        <createTable schemaName="public" tableName="storage_object">
            <column name="key" type="VARCHAR(1024)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="storage_object_pkey"/>
            </column>
            <column name="size" type="int4" defaultValueNumeric="0"/>
            <column name="hash" type="VARCHAR(1024)"/>
        </createTable>
    </changeSet>
    <!-- to add caching for pages -->
    <changeSet author="fmguler" id="24">
        <addColumn tableName="page" schemaName="public">
            <column name="last_modified" type="TIMESTAMP WITHOUT TIME ZONE" defaultValueDate="now()" />
        </addColumn>
    </changeSet>
    <!-- << ATTACHMENT SUPPORT -->
</databaseChangeLog>